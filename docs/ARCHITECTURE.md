# Архитектура Gatling Prometheus Plugin

## Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ LegacyMetrics   │  │ LegacyHttp      │  │ LegacyGlobal    │ │
│  │ Manager         │  │ MetricsCollector│  │ VUTracker       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              MetricsApplicationService                      │ │
│  │  • Orchestrates domain services                            │ │
│  │  • Manages lifecycle                                       │ │
│  │  • Coordinates operations                                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              MetricsServiceFactory                          │ │
│  │  • Creates dependencies                                    │ │
│  │  • Configures components                                   │ │
│  │  • Dependency injection                                    │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DOMAIN LAYER                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ MetricCollector │  │ MetricExporter  │  │ VirtualUser     │ │
│  │ (Interface)     │  │ (Interface)     │  │ Tracker         │ │
│  └─────────────────┘  └─────────────────┘  │ (Interface)     │ │
│  ┌─────────────────┐  ┌─────────────────┐  └─────────────────┘ │
│  │ MetricRepository│  │ Configuration   │  ┌─────────────────┐ │
│  │ (Interface)     │  │ Models          │  │ Metric Models   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                 INFRASTRUCTURE LAYER                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Prometheus      │  │ Prometheus      │  │ Prometheus      │ │
│  │ MetricRepository│  │ MetricCollector │  │ VirtualUser     │ │
│  │ (Implementation)│  │ (Implementation)│  │ Tracker         │ │
│  └─────────────────┘  └─────────────────┘  │ (Implementation)│ │
│  ┌─────────────────┐  ┌─────────────────┐  └─────────────────┘ │
│  │ Prometheus      │  │ Configuration   │  ┌─────────────────┐ │
│  │ RemoteExporter  │  │ Loader          │  │ Protobuf        │ │
│  │ (Implementation)│  │ (Implementation)│  │ Serializer      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    EXTERNAL SYSTEMS                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Prometheus      │  │ VictoriaMetrics │  │ Gatling         │ │
│  │ Registry        │  │ Remote Write    │  │ Framework       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Слои архитектуры

### 1. Presentation Layer (Слой представления)
**Назначение**: Обеспечивает обратную совместимость с существующим API

**Компоненты**:
- `LegacyMetricsManager` - адаптер для старого PrometheusMetricsManager
- `LegacyHttpMetricsCollector` - адаптер для HttpMetricsCollector
- `LegacyGlobalVUTracker` - адаптер для GlobalVUTracker

**Принципы**:
- Делегирует вызовы к Application Layer
- Сохраняет существующий API без изменений
- Обеспечивает плавную миграцию

### 2. Application Layer (Слой приложения)
**Назначение**: Оркестрирует бизнес-логику и координирует доменные сервисы

**Компоненты**:
- `MetricsApplicationService` - основной сервис приложения
- `MetricsServiceFactory` - фабрика для создания зависимостей

**Принципы**:
- Не содержит бизнес-логики
- Координирует доменные сервисы
- Управляет жизненным циклом
- Использует Dependency Injection

### 3. Domain Layer (Доменный слой)
**Назначение**: Содержит бизнес-логику и доменные модели

**Компоненты**:
- **Модели**: `Metric`, `TestConfiguration`, `RemoteWriteConfiguration`
- **Интерфейсы**: `MetricRepository`, `MetricCollector`, `MetricExporter`, `VirtualUserTracker`
- **Доменные сервисы**: Определяют контракты для бизнес-операций

**Принципы**:
- Не зависит от внешних слоев
- Содержит чистую бизнес-логику
- Определяет интерфейсы для внешних зависимостей
- Использует Domain-Driven Design

### 4. Infrastructure Layer (Инфраструктурный слой)
**Назначение**: Реализует технические детали и интеграции

**Компоненты**:
- `PrometheusMetricRepository` - хранение метрик в Prometheus
- `PrometheusMetricCollector` - сбор метрик
- `PrometheusRemoteExporter` - экспорт в VictoriaMetrics
- `PrometheusVirtualUserTracker` - отслеживание VU
- `ConfigurationLoader` - загрузка конфигурации
- `ProtobufSerializer` - сериализация в protobuf

**Принципы**:
- Реализует интерфейсы из Domain Layer
- Содержит технические детали
- Может быть заменен без изменения бизнес-логики
- Использует внешние библиотеки

## Поток данных

```
Gatling Framework
        │
        ▼
┌─────────────────┐
│ Presentation    │ ← Legacy API calls
│ Layer           │
└─────────────────┘
        │
        ▼
┌─────────────────┐
│ Application     │ ← Orchestration
│ Layer           │
└─────────────────┘
        │
        ▼
┌─────────────────┐
│ Domain Layer    │ ← Business logic
│                 │
└─────────────────┘
        │
        ▼
┌─────────────────┐
│ Infrastructure  │ ← Technical implementation
│ Layer           │
└─────────────────┘
        │
        ▼
┌─────────────────┐
│ External        │ ← Prometheus, VictoriaMetrics
│ Systems         │
└─────────────────┘
```

## Принципы SOLID

### Single Responsibility Principle (SRP)
- Каждый класс имеет одну ответственность
- `MetricRepository` - только хранение
- `MetricCollector` - только сбор
- `MetricExporter` - только экспорт

### Open/Closed Principle (OCP)
- Легко добавлять новые типы метрик
- Новые экспортеры без изменения существующего кода
- Расширение через наследование и композицию

### Liskov Substitution Principle (LSP)
- Все реализации интерфейсов полностью заменяемы
- `PrometheusMetricRepository` может быть заменен на `InMemoryMetricRepository`

### Interface Segregation Principle (ISP)
- Интерфейсы разделены по функциональности
- Клиенты зависят только от нужных методов
- Нет "толстых" интерфейсов

### Dependency Inversion Principle (DIP)
- Высокоуровневые модули не зависят от низкоуровневых
- Все зависимости инвертированы через интерфейсы
- Абстракции не зависят от деталей

## Преимущества архитектуры

### 1. Тестируемость
- Каждый слой можно тестировать изолированно
- Легко создавать моки и стабы
- Unit тесты для каждого компонента

### 2. Расширяемость
- Легко добавлять новые типы метрик
- Новые экспортеры без изменения кода
- Плагинная архитектура

### 3. Поддерживаемость
- Четкое разделение ответственности
- Легко понимать и изменять код
- Минимальные побочные эффекты

### 4. Обратная совместимость
- Существующий код работает без изменений
- Плавная миграция на новую архитектуру
- Адаптеры скрывают изменения

### 5. Производительность
- Асинхронная обработка метрик
- Батчинг для экспорта
- Эффективное использование ресурсов

## Миграционная стратегия

### Фаза 1: Текущее состояние
- Использование Legacy API
- Вся функциональность работает как раньше
- Новая архитектура работает под капотом

### Фаза 2: Постепенная миграция
- Новые компоненты используют новый API
- Старые компоненты постепенно мигрируют
- Смешанное использование API

### Фаза 3: Полная миграция
- Все компоненты используют новый API
- Legacy адаптеры могут быть удалены
- Чистая архитектура везде

## Заключение

Новая архитектура обеспечивает:
- **Чистоту кода** через разделение на слои
- **Гибкость** через интерфейсы и DI
- **Тестируемость** через изоляцию компонентов
- **Расширяемость** через открытые принципы
- **Совместимость** через адаптеры

Это позволяет легко развивать проект, добавлять новую функциональность и поддерживать высокое качество кода.
